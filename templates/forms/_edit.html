{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}
{% includeCssResource "formbuilder/css/formbuilder.css" %}

{% set selectedTab = '' %}
{% set docsUrl = 'http://roundhouse.github.io/FormBuilder-Craft-CMS/#addform' %}

{% set extraPageHeaderHtml %}
  <a href="{{ url('formbuilder') }}">
  <div class="icon">
  <?xml version="1.0" encoding="utf-8"?>
  <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
    <svg version="1.1" id="layers" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
       width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
      <polygon id="layer3" points="80.5,60 94.9,67 49.9,88.6 4.9,67 19.4,60 22.5,61.5 11.3,67 49.9,85.6 88.6,67 77.3,61.5 "/>
      <polygon id="layer2" points="77.3,44.6 88.6,50 49.9,68.6 11.3,50 22.5,44.6 19.4,43.1 4.9,50 49.9,71.7 94.9,50 80.5,43.1 "/>
      <polygon id="layer1" points="94.9,33.1 49.9,11.4 4.9,33.1 49.9,54.7 "/>
    </svg>
  </div>
  <img src="{{ resourceUrl('formbuilder/images/formBuilder_logo.png') }}" /></a>
{% endset %}

{% block content %}
<section id="create-form">
	<h1 class="settings-toggle">{{ "Form Settings"|t }}</h1>
	<form method="post" accept-charset="UTF-8" data-saveshortcut="1">
		<input type="hidden" name="action" value="formBuilder/forms/saveForm">
		<input type="hidden" name="redirect" value="formbuilder/forms">
		{{ getCsrfInput() }}
		{% if form.id %}<input type="hidden" name="formId" value="{{ form.id }}">{% endif %}

		<div id="settings-container">
		<div class="fieldset">
		{{ forms.textField({
			first: true,
			label: "Form Name"|t,
			instructions: "Give this form a name."|t,
			id: 'name',
			name: 'name',
			value: form.name,
			errors: form.getErrors('name'),
			autofocus: true,
			required: true,
			translatable: true
		}) }}

		{{ forms.textField({
			label: "Handle"|t,
			instructions: "How youâ€™ll refer to this form in the templates."|t,
			id: 'handle',
			class: 'code',
			name: 'handle',
			value: form.handle,
			errors: form.getErrors('handle'),
			required: true
		}) }}
		
		{{ forms.textField({
			label: "Email Subject"|t,
			instructions: "Subject line for email notifications"|t,
			id: 'subject',
			class: 'subject',
			name: 'subject',
			value: form.subject,
			errors: form.getErrors('subject'),
			required: false
		}) }}
		</div>
		</div>

		<hr />

		<h1 class="messages-toggle">{{ "Messages"|t }}</h1>
		<div id="messages-container">
			<div class="fieldset">
			{{ forms.textField({
				label: "Success Message"|t,
				instructions: "Please enter success message"|t,
				id: 'successMessage',
				class: 'successMessage',
				name: 'successMessage',
				value: form.successMessage,
				errors: form.getErrors('successMessage'),
				required: false
			}) }}

			{{ forms.textField({
				label: "Error Message"|t,
				instructions: "Please enter error message."|t,
				id: 'errorMessage',
				class: 'errorMessage',
				name: 'errorMessage',
				value: form.errorMessage,
				errors: form.getErrors('errorMessage'),
				required: false
			}) }}

			</div>
		</div>

		<hr />

		{# NOTIFICATIONS TOGGLE #}
		<h1 class="notifications-toggle">{{ "Notifications"|t }}</h1>
		<div id="notifications-container">
			{# ################################ #}
			{# Notify Form Owner #}
			{# ################################ #}
			<div class="fieldset notifications">
				{{ forms.checkboxField({
					label: "Send Notification?"|t,
					instructions: "Should the form send notification to form owner?"|t,
					id: 'notifyFormAdmin',
					class: 'notifyFormAdmin',
					name: 'notifyFormAdmin',
					value: 1,
					checked: form.notifyFormAdmin,
					errors: form.getErrors('notifyFormAdmin'),
					required: false
				}) }}
			
				<div class="notifyEmailTemplate" style="width: 100%;">
					<div class="fieldset child">
					{{ forms.textField({
						label: "To Email"|t,
						instructions: "Where should this form send to?"|t,
						id: 'toEmail',
						class: 'toEmail',
						name: 'toEmail',
						value: form.toEmail,
						errors: form.getErrors('toEmail'),
						required: false
					}) }}

					{{ forms.textField({
						label: "Email Template Path"|t,
						instructions: "Enter Email Template Path. default 'formbuilder/email/default'"|t,
						id: 'notificationTemplatePath',
						class: 'notificationTemplatePath',
						name: 'notificationTemplatePath',
						value: form.notificationTemplatePath ? form.notificationTemplatePath : "formbuilder/email/default"|t,
						errors: form.getErrors('notificationTemplatePath'),
						required: true
					}) }}
					</div>
				</div>
			
			{# ################################ #}
			{# Notify Form Submitter #}
			{# ################################ #}
			{% if form.id %}
				{% set formId = craft.formBuilder.getFormById(form.id) %}
				{% set fields = formId.fieldLayout.getFieldLayout().getFields() %}
				{% set groupOptions = [{label: 'Select Email Field', value: '0'}] %}
				{% for field in fields %}
					{% set item = field.getField(field) %}
					{% set groupOptions = groupOptions|merge([{ label: item.name, value: item.handle }]) %}
				{% endfor %}

				{{ forms.checkboxField({
					label: "Notify Registrant?"|t,
					instructions: "Should the form send notification to registrant?"|t,
					id: 'notifyRegistrant',
					class: 'notifyRegistrant',
					name: 'notifyRegistrant',
					value: 1,
					checked: form.notifyRegistrant,
					errors: form.getErrors('notifyRegistrant'),
					required: false
				}) }}
				
				<div class="registrantEmailTemplate" style="width: 100%;">
				<div class="fieldset child">
				{{ forms.textField({
					label: "Registrant Email Template Path"|t,
					instructions: "Enter Email Template Path for Registrant. default 'formbuilder/email/registrant'"|t,
					id: 'notificationTemplatePathRegistrant',
					class: 'notificationTemplatePathRegistrant',
					name: 'notificationTemplatePathRegistrant',
					value: form.notificationTemplatePathRegistrant ? form.notificationTemplatePathRegistrant : "formbuilder/email/registrant"|t,
					errors: form.getErrors('notificationTemplatePathRegistrant'),
					required: true
				}) }}
				
				{% if fields %}
				{{ forms.selectField ({
					label: "Notification Field"|t,
					instructions: "Which field should we use to send out notification email? Note: field must be first added to the Fields below and saved."|t,
					id: 'notificationFieldHandleName',
					class: 'notificationFieldHandleName',
					name: 'notificationFieldHandleName',
					options: groupOptions ? groupOptions : '',
					value: form.notificationFieldHandleName ? form.notificationFieldHandleName : '',
					required: true
				}) }}
				{% endif %}
				</div>
				</div>
			{% endif %}
			</div>
		</div> {# END NOTIFICATIONS TOGGLE #}
		
		<hr>
		
		<h1 class="fields-toggle">{{ "Fields"|t }}</h1>
		<div id="fields-container">
		{% include "formbuilder/_includes/fieldlayoutdesigner" with {
			fieldLayout: form.getFieldLayout(),
			customizableTabs: true
		} only %}
		</div>

		<hr>

		<div class="buttons">
			<input type="submit" class="btn submit" value="{{ 'Save'|t }}">
		</div>

	</form>
</section>

{% endblock %}


{% set notificationJs %}
	{% if not form.handle %}new Craft.HandleGenerator('#name', '#handle');{% endif %}
	
	{# Toggle Fields Container #}
	$('#fields-container').slideUp()
	$('.fields-toggle').on('click', function(e){
		$('#fields-container').slideToggle()
	});

	{# Toggle Settings Container #}
	$('.settings-toggle').on('click', function(e){
		$('#settings-container').slideToggle()
	});

	{# Toggle Messages Container #}
	$('#messages-container').slideUp()
	$('.messages-toggle').on('click', function(e){
		$('#messages-container').slideToggle()
	});

	{# Toggle Notifications Container #}
	$('#notifications-container').slideUp()
	$('.notifications-toggle').on('click', function(e){
		$('#notifications-container').slideToggle()
	});


	{# Notify Registrant Toggle #}
	if($(".notifyRegistrant").is(':checked')) {
		$('.registrantEmailTemplate').show()
	} else {
		$('.registrantEmailTemplate').hide()
	}

  $(".notifyRegistrant").change(function() {
    if(this.checked) {
    	$('.registrantEmailTemplate').slideDown()
    } else {
    	$('.registrantEmailTemplate').slideUp()
    }
  });

	{# Notify Admin Toggle #}
	if($(".notifyFormAdmin").is(':checked')) {
		$('.notifyEmailTemplate').show()
	} else {
		$('.notifyEmailTemplate').hide()
	}

  $(".notifyFormAdmin").change(function() {
    if(this.checked) {
    	$('.notifyEmailTemplate').slideDown()
    } else {
    	$('.notifyEmailTemplate').slideUp()
    }
  });

{% endset %}
{% includeJs notificationJs %}
